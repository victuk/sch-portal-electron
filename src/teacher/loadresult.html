<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./res/style.css" />
    <link rel="stylesheet" href="../resources/js/notification/notify.min.css" />
    <link rel="stylesheet" href="../resources/css/bootstrap.min.css" />
    <title>Document</title>
  </head>
  <body>
    <div class="app-container">
      <div class="sidebar">
        <div class="sidebar-header">
          <div class="app-icon">
            <svg viewBox="0 0 512 512" xmlns="http://www.w3.org/2000/svg">
              <path
                fill="currentColor"
                d="M507.606 371.054a187.217 187.217 0 00-23.051-19.606c-17.316 19.999-37.648 36.808-60.572 50.041-35.508 20.505-75.893 31.452-116.875 31.711 21.762 8.776 45.224 13.38 69.396 13.38 49.524 0 96.084-19.286 131.103-54.305a15 15 0 004.394-10.606 15.028 15.028 0 00-4.395-10.615zM27.445 351.448a187.392 187.392 0 00-23.051 19.606C1.581 373.868 0 377.691 0 381.669s1.581 7.793 4.394 10.606c35.019 35.019 81.579 54.305 131.103 54.305 24.172 0 47.634-4.604 69.396-13.38-40.985-.259-81.367-11.206-116.879-31.713-22.922-13.231-43.254-30.04-60.569-50.039zM103.015 375.508c24.937 14.4 53.928 24.056 84.837 26.854-53.409-29.561-82.274-70.602-95.861-94.135-14.942-25.878-25.041-53.917-30.063-83.421-14.921.64-29.775 2.868-44.227 6.709-6.6 1.576-11.507 7.517-11.507 14.599 0 1.312.172 2.618.512 3.885 15.32 57.142 52.726 100.35 96.309 125.509zM324.148 402.362c30.908-2.799 59.9-12.454 84.837-26.854 43.583-25.159 80.989-68.367 96.31-125.508.34-1.267.512-2.573.512-3.885 0-7.082-4.907-13.023-11.507-14.599-14.452-3.841-29.306-6.07-44.227-6.709-5.022 29.504-15.121 57.543-30.063 83.421-13.588 23.533-42.419 64.554-95.862 94.134zM187.301 366.948c-15.157-24.483-38.696-71.48-38.696-135.903 0-32.646 6.043-64.401 17.945-94.529-16.394-9.351-33.972-16.623-52.273-21.525-8.004-2.142-16.225 2.604-18.37 10.605-16.372 61.078-4.825 121.063 22.064 167.631 16.325 28.275 39.769 54.111 69.33 73.721zM324.684 366.957c29.568-19.611 53.017-45.451 69.344-73.73 26.889-46.569 38.436-106.553 22.064-167.631-2.145-8.001-10.366-12.748-18.37-10.605-18.304 4.902-35.883 12.176-52.279 21.529 11.9 30.126 17.943 61.88 17.943 94.525.001 64.478-23.58 111.488-38.702 135.912zM266.606 69.813c-2.813-2.813-6.637-4.394-10.615-4.394a15 15 0 00-10.606 4.394c-39.289 39.289-66.78 96.005-66.78 161.231 0 65.256 27.522 121.974 66.78 161.231 2.813 2.813 6.637 4.394 10.615 4.394s7.793-1.581 10.606-4.394c39.248-39.247 66.78-95.96 66.78-161.231.001-65.256-27.511-121.964-66.78-161.231z"
              />
            </svg>
          </div>
        </div>
        <ul class="sidebar-list"></ul>
        <div class="account-info">
          <div class="account-info-picture">
            <img id="image-src" alt="Profile picture" />
          </div>
          <div class="account-info-name" id="person-name"></div>
          <button class="account-info-more">
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="24"
              height="24"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
              class="feather feather-more-horizontal"
            >
              <circle cx="12" cy="12" r="1" />
              <circle cx="19" cy="12" r="1" />
              <circle cx="5" cy="12" r="1" />
            </svg>
          </button>
        </div>
      </div>
      <div class="app-content">
        <div class="app-content-header">
          <div class="menu-bars">
            <div class="menu-bar"></div>
            <div class="menu-bar"></div>
            <div class="menu-bar"></div>
            <div class="menu-bar"></div>
          </div>
          <h1 class="app-content-headerText">Assessment Manager</h1>
          <button class="mode-switch" title="Switch Theme">
            <svg
              class="moon"
              fill="none"
              stroke="currentColor"
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              width="24"
              height="24"
              viewBox="0 0 24 24"
            >
              <defs></defs>
              <path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"></path>
            </svg>
          </button>
          <button class="btn btn-danger" onclick="logOut()">Log out</button>
        </div>

        <style>
          .flex-it {
            display: flex;
            align-items: center;
            gap: 40px;
          }

          .flex-it > div {
            display: flex;
            /* align-items: center; */
            flex-direction: column;
            gap: 5px;
          }

          @media screen and (max-width: 1024px) {
            .flex-it {
              flex-direction: column;
              align-items: start;
            }

            .flex-it > div {
              flex-direction: column;
              align-items: start;
            }
          }

        </style>

        <div id="l-res">
          <div>
            <form class="my-4 flex-it">
              <div>
                <div>Term:</div>
              <select name="term" id="term">
                <option value="select">-- Choose term --</option>
                <option value="first-term">First term</option>
                <option value="second-term">Second term</option>
                <option value="third-term">Third term</option>
              </select>
              </div>
              

              <!-- Class:
            <select name="class" id="class">
              <option value="select">-- Choose class --</option>
              <option value="js1">JS 1</option>
              <option value="js2">JS 2</option>
              <option value="js3">JS 3</option>
              <option value="ss1">SS 1</option>
              <option value="ss2">SS 2</option>
              <option value="ss3">SS 3</option>
            </select>
            <br />
            <br /> -->
              <div>
                <div>Year:</div>
                <select name="year" id="year"></select>
              </div>

              <div>
                <div>Subject(s):</div>
                <select name="subjects" id="subjects">
                  <option value="select">-- Choose Subject --</option>
                </select>
              </div>
            </form>

            <div>
              <button id="load-result" class="button-design">
                Load Result
              </button>
            </div>

            <div>
              <table id="table-data" class="paleBlueRows">
                <thead>
                  <tr>
                    <th colspan="6">Choose a term, year and subject.</th>
                    <!-- <th>Surname</th>
                    <th>Other Names</th>
                    <th>Gender</th>
                    <th>First Test</th>
                    <th>Second Test</th>
                    <th>Third Test</th>
                    <th>Exam Score</th>
                    <th>Total</th>
                    <th>Grade</th>
                    <th>Remark</th>
                    <th>Update Button</th> -->
                  </tr>
                </thead>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <style>
      select {
        padding: 6px 20px;
        border:	1px solid rgba(0,0,0,0.1);
        border-radius:	4px;
        background-color: white;
        border-radius: 3px;
      }

      #l-res {
        padding: 40px 0;
        overflow: auto;
        width: 100%;
        max-height: 100%;
      }

      .button-design {
        border-radius: 3px;
        border: 1px solid #24c464;
        color: #24c464;
        padding: 6px 10px;
        background-color: white;
        transition: 0.5s;
      }
      
      .button-design:hover {
        background-color: #24c464;
        color: white;
      }

      .score {
        width: 40px;
        /* border: 2px solid blue; */
        border: none;
        padding: 4px 10px;
        border-radius: 4px;
        background-color: #5af397;
      }

      table.paleBlueRows {
        font-family: "Times New Roman", Times, serif;
        border: 1px solid #ffffff;
        width: 100%;
        height: 50px;
        text-align: center;
        border-collapse: collapse;
      }
      table.paleBlueRows td,
      table.paleBlueRows th {
        border: 1px solid #ffffff;
        padding: 10px 2px;
      }
      /* table.paleBlueRows tbody tr {
        font-size: 13px;
      } */
      table.paleBlueRows tr:nth-child(even) {
        background: #d0e4f5;
      }
      table.paleBlueRows thead {
        /* background: #0b6fa4; */
        border-bottom: 5px solid #ffffff;
      }
      table.paleBlueRows thead th {
        font-size: 17px;
        font-weight: bold;
        color: black;
        text-align: center;
      }
      table.paleBlueRows thead th:first-child {
        border-left: none;
      }

      table.paleBlueRows tfoot {
        font-size: 14px;
        font-weight: bold;
        color: #333333;
        background: #d0e4f5;
        border-top: 3px solid #444444;
      }
      table.paleBlueRows tfoot td {
        font-size: 14px;
      }
    </style>

    <script src="./res/sidebar.js"></script>
    <script src="../scripts/baseUrl.js"></script>
    <script src="./res/script.js"></script>
    <script src="../resources/js/notification/notify.min.js"></script>
    <script src="../scripts/moment.min.js"></script>
    <script>
      const termValue = document.getElementById("term");
      const classValue = document.getElementById("class");
      const yearValue = document.getElementById("year");
      const subjects = document.getElementById("subjects");

      const tableData = document.getElementById("table-data");

      let allResults;

      (async function () {
        document.getElementById("year").innerHTML = `
      <option value="select">-- Choose year --</option>
            <option value="${
              new Date().getFullYear() - 1
            }/${new Date().getFullYear()}">${new Date().getFullYear()}/${
          new Date().getFullYear() + 1
        }</option>
            <option value="${
              new Date().getFullYear() - 1
            }/${new Date().getFullYear()}">${
          new Date().getFullYear() - 1
        }/${new Date().getFullYear()} (Current year)</option>
            <option value="${new Date().getFullYear() - 2}/${
          new Date().getFullYear() - 1
        }">${new Date().getFullYear() - 2}/${
          new Date().getFullYear() - 1
        }</option>
            <option value="${new Date().getFullYear() - 3}/${
          new Date().getFullYear() - 2
        }">${new Date().getFullYear() - 3}/${
          new Date().getFullYear() - 2
        }</option>
        `;

        const teachersDetails = await fetch(baseUrl + "teacher/profile", {
          method: "GET",
          headers: {
            accesstoken,
          },
        });

        const data = await teachersDetails.json();

        if (teachersDetails.status == 200) {
          for (let s of data.teacherDetails.subjectsClass) {
            subjects.innerHTML += `
                    <option value="${s.subjectCode},${s.subjectClass}">${
              s.subjectName
            } - ${s.subjectClass.toUpperCase()}</option>
                    `;
          }
        }
      })();

      document
        .getElementById("load-result")
        .addEventListener("click", async function (e) {
          e.preventDefault();

          if (
            termValue.value == "select" ||
            subjects.value == "select" ||
            yearValue.value == "select"
          ) {
            alert("Incomplete details");
          } else {
            let subjectAndClass = subjects.value.split(",");

            const results = await fetch(
              baseUrl + "teacher/student-class-record",
              {
                method: "POST",
                headers: {
                  accesstoken,
                  "Content-Type": "application/json",
                },
                body: JSON.stringify({
                  year: yearValue.value,
                  studentClass: subjectAndClass[1],
                  term: termValue.value,
                  subject: subjectAndClass[0],
                }),
              }
            );

            const data = await results.json();

            allResults = data.results;

            tableData.innerHTML = `
          <thead>
            <tr>
          <th>First Name</th>
          <th>Surname</th>
          <!-- <th>Other Names</th> -->
          <!-- <th>Gender</th> -->
          <th>First Test</th>
          <th>Second Test</th>
          <th>Third Test</th>
          <th>Exam Score</th>
          <th>Total</th>
          <th>Grade</th>
          <!-- <th>Remark</th> -->
          <th>Update Button</th>
        </tr>
      </thead>
      <tbody>
            `;

            for (let r of allResults) {
              tableData.innerHTML += `
              <tr>
          <td>${r.firstName[0].toUpperCase() + r.firstName.slice(1)}</td>
          <td>${r.surName[0].toUpperCase() + r.surName.slice(1)}</td>
          <!-- <td>${r.otherNames[0].toUpperCase() + r.otherNames.slice(1)}</td> -->
          <!-- <td>${r.gender[0].toUpperCase() + r.gender.slice(1)}</td> -->
          <td><input type="text" class="score" id="${
            r.studentID
          }-testone" value="${r.testOne}">/10</td>
          <td><input type="text" class="score" id="${
            r.studentID
          }-testtwo" value="${r.testTwo}">/10</td>
          <td><input type="text" class="score" id="${
            r.studentID
          }-testthree" value="${r.testThree}">/10</td>
          <td><input type="text" class="score" id="${
            r.studentID
          }-exam" value="${r.examScore}">/70</td>
          <td>${r.total}/100</td>
          <td>${r.grade}</td>
          <!-- <td>${r.remark}</td> -->
          <td><button class="btn btn-link" onclick="updateScore('${
            r.studentID
          }', '${r.mode}', '${r.studentClass}', '${r.term}', '${r.year}', '${
                r.subject
              }')">Update</button></td>
              </tr>
              `;
            }
            tableData.innerHTML += "</tbody>";
            calculateAverage();
          }
        });

      async function updateScore(
        studentID,
        recordMode,
        studentClass,
        term,
        year,
        subject
      ) {
        const testOne = document.getElementById(`${studentID}-testone`).value;
        const testTwo = document.getElementById(`${studentID}-testtwo`).value;
        const testThree = document.getElementById(
          `${studentID}-testthree`
        ).value;
        const examScore = document.getElementById(`${studentID}-exam`).value;

        let response = await fetch(
          baseUrl + "teacher/student-record/" + studentID,
          {
            method: "PUT",
            headers: {
              accesstoken,
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              recordMode,
              testOne,
              testTwo,
              testThree,
              examScore,
              subject,
              term,
              studentClass,
              year,
            }),
          }
        );

        const data = await response.json();

        if (response.status == (200 || 201)) {
          // let updatedResult = allResults.filter(result => {
          //   return studentID != data.resultResponse.studentID;
          // });

          notify({
            message: "Update Successful.",
            color: "success",
            timeout: 2000,
          });

          for (let result of allResults) {
            if (result.studentID == data.resultResponse.studentID) {
              result.testOne = data.resultResponse.testOne;
              result.testTwo = data.resultResponse.testTwo;
              result.testThree = data.resultResponse.testThree;
              result.remark = data.resultResponse.remark;
              result.grade = data.resultResponse.grade;
              result.total = data.resultResponse.total;
              result.passportPicture = data.resultResponse.passportPicture;
              result.passportPublicId = data.resultResponse.passportPublicId;
              result.studentID = data.resultResponse.studentID;
              result.firstName = data.resultResponse.firstName;
              result.subject = data.resultResponse.subject;
              result.surName = data.resultResponse.surName;
              result.otherNames = data.resultResponse.otherNames;
              result.gender = data.resultResponse.gender;
              result.examScore = data.resultResponse.examScore;
            }
          }

          tableData.innerHTML = `
          <thead>
            <tr>
          <th>Surname</th>
          <th>First Name</th>
          <th>Other Names</th>
          <th>Gender</th>
          <th>First Test</th>
          <th>Second Test</th>
          <th>Third Test</th>
          <th>Exam Score</th>
          <th>Total</th>
          <th>Grade</th>
          <th>Remark</th>
          <th>Action</th>
        </tr>
        </thead>
        <tbody>
            `;

          console.log(allResults);

          for (let r of allResults) {
            tableData.innerHTML += `
              <tr>
          <td>${r.surName[0].toUpperCase() + r.surName.slice(1)}</td>
          <td>${r.firstName[0].toUpperCase() + r.firstName.slice(1)}</td>
          <td>${r.otherNames[0].toUpperCase() + r.otherNames.slice(1)}</td>
          <td>${r.gender[0].toUpperCase() + r.gender.slice(1)}</td>
          <td><input type="text" class="score" id="${
            r.studentID
          }-testone" value="${r.testOne}"></td>
          <td><input type="text" class="score" id="${
            r.studentID
          }-testtwo" value="${r.testTwo}"></td>
          <td><input type="text" class="score" id="${
            r.studentID
          }-testthree" value="${r.testThree}"></td>
          <td><input type="text" class="score" id="${
            r.studentID
          }-exam" value="${r.examScore}"></td>
          <td>${r.total}</td>
          <td>${r.grade}</td>
          <td>${r.remark}</td>
          <td><button class="btn btn-success" onclick="updateScore('${
            r.studentID
          }', '${r.mode}', '${r.studentClass}', '${r.term}', '${r.year}', '${
              r.subject
            }')">Update Score</button></td>
              </tr>
              `;
          }
          ableData.innerHTML += "</tbody>";
          calculateAverage();
        } else {
          notify({
            message: "Coudn't update score.",
            color: "danger",
            timeout: 2000,
          });
        }
      }

      function calculateAverage() {
        let avg = 0;
        for (let i = 0; i < allResults.length; i++) {
          avg += allResults[i].total;
        }
        let averageScore = avg / allResults.length;
        console.log(averageScore);
      }
    </script>
    <script src="./res/profile.js"></script>
  </body>
</html>
